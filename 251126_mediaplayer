// build.gradle (module)
// implementation "androidx.media3:media3-exoplayer:1.5.1"
// implementation "androidx.media3:media3-ui:1.5.1"
// implementation "androidx.compose.ui:ui:1.7.0"
// implementation "androidx.compose.foundation:foundation:1.7.0"
// implementation "androidx.compose.material:material:1.7.0"

package com.example.mediaplayerfft

import android.graphics.Bitmap
import android.graphics.BitmapShader
import android.graphics.RuntimeShader
import android.graphics.Shader
import android.media.audiofx.Visualizer
import android.net.Uri
import androidx.compose.animation.core.LinearEasing
import androidx.compose.animation.core.animateFloatAsState
import androidx.compose.animation.core.infiniteRepeatable
import androidx.compose.animation.core.rememberInfiniteTransition
import androidx.compose.animation.core.tween
import androidx.compose.foundation.layout.*
import androidx.compose.material.Icon
import androidx.compose.material.IconButton
import androidx.compose.material.MaterialTheme
import androidx.compose.material.Surface
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Pause
import androidx.compose.material.icons.filled.PlayArrow
import androidx.compose.material.icons.filled.SkipNext
import androidx.compose.material.icons.filled.SkipPrevious
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.drawWithCache
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.ShaderBrush
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.media3.common.C
import androidx.media3.common.MediaItem
import androidx.media3.common.Player
import androidx.media3.exoplayer.ExoPlayer
import kotlin.math.abs
import kotlin.math.log10
import kotlin.math.sqrt

// ---------------------- AGSL SHADER ----------------------

private const val WAVE_SHADER_AGSL = """
uniform float2 iResolution;
uniform float  iTime;
uniform float  WAVES;
uniform shader iChannel0;

half4 main(float2 fragCoord) {
    float2 uv = -1.0 + 2.0 * fragCoord / iResolution;

    float time = iTime;
    float3 color = float3(0.0);

    for (float i = 0.0; i < WAVES + 1.0; i += 1.0) {
        float freq = sample(iChannel0, float2(i / WAVES, 0.0)).x * 7.0;

        float2 p = uv;

        p.x += i * 0.04 + freq * 0.03;
        p.y += sin(p.x * 10.0 + time) * cos(p.x * 2.0) * freq * 0.2 * ((i + 1.0) / WAVES);

        float intensity = abs(0.01 / p.y) * clamp(freq, 0.35, 2.0);
        color += float3(
            1.0 * intensity * (i / 5.0),
            0.5 * intensity,
            1.75 * intensity
        ) * (3.0 / WAVES);
    }

    return half4(color, 1.0);
}
"""

// ---------------------- PLAYER + UI ----------------------

@Composable
fun FftMediaPlayer(
    audioUris: List<Uri>,
    modifier: Modifier = Modifier
) {
    val context = LocalContext.current

    val player = remember {
        ExoPlayer.Builder(context).build().apply {
            val items = audioUris.map { MediaItem.fromUri(it) }
            setMediaItems(items)
            prepare()
        }
    }

    var isPlaying by remember { mutableStateOf(false) }

    LaunchedEffect(isPlaying) {
        if (isPlaying) player.play() else player.pause()
    }

    DisposableEffect(Unit) {
        onDispose { player.release() }
    }

    Column(
        modifier = modifier
            .fillMaxWidth()
            .padding(16.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {

        SoundWaveShaderView(
            player = player,
            isPlaying = isPlaying,
            modifier = Modifier
                .fillMaxWidth()
                .height(150.dp)
        )

        Spacer(Modifier.height(24.dp))

        Row(verticalAlignment = Alignment.CenterVertically) {
            IconButton(onClick = { player.seekToPreviousMediaItem() }) {
                Icon(Icons.Default.SkipPrevious, contentDescription = "Previous")
            }
            IconButton(onClick = { isPlaying = !isPlaying }) {
                Icon(
                    if (isPlaying) Icons.Default.Pause else Icons.Default.PlayArrow,
                    contentDescription = "Play/Pause"
                )
            }
            IconButton(onClick = { player.seekToNextMediaItem() }) {
                Icon(Icons.Default.SkipNext, contentDescription = "Next")
            }
        }
    }
}

// ---------------------- FFT → BITMAP → SHADER ----------------------

@Composable
private fun rememberFftShader(player: ExoPlayer): Shader? {
    var fftShader by remember { mutableStateOf<Shader?>(null) }

    DisposableEffect(player) {
        var visualizer: Visualizer? = null

        val listener = object : Player.Listener {
            override fun onAudioSessionIdChanged(audioSessionId: Int) {
                if (audioSessionId == C.AUDIO_SESSION_ID_UNSET) return

                visualizer?.release()
                visualizer = Visualizer(audioSessionId).apply {
                    captureSize = Visualizer.getCaptureSizeRange()[1]

                    setDataCaptureListener(
                        object : Visualizer.OnDataCaptureListener {
                            override fun onFftDataCapture(
                                v: Visualizer,
                                fft: ByteArray,
                                samplingRate: Int
                            ) {
                                val width = 256
                                val height = 1
                                val bmp = Bitmap.createBitmap(
                                    width,
                                    height,
                                    Bitmap.Config.ARGB_8888
                                )

                                // fft: [real0, imag0, real1, imag1, ...]
                                for (x in 0 until width) {
                                    val index = x * 2
                                    if (index + 1 >= fft.size) break

                                    val re = fft[index].toInt().toFloat()
                                    val im = fft[index + 1].toInt().toFloat()
                                    val mag = sqrt(re * re + im * im)

                                    // log scale & normalize
                                    var vMag = if (mag > 0f) (20f * log10(mag)) else 0f
                                    vMag = (vMag + 60f) / 60f   // roughly 0..1
                                    vMag = vMag.coerceIn(0f, 1f)

                                    val r = (vMag * 255).toInt()
                                    val g = (vMag * 128).toInt()
                                    val b = 255

                                    val color = android.graphics.Color.argb(255, r, g, b)
                                    bmp.setPixel(x, 0, color)
                                }

                                fftShader = BitmapShader(
                                    bmp,
                                    Shader.TileMode.CLAMP,
                                    Shader.TileMode.CLAMP
                                )
                            }

                            override fun onWaveFormDataCapture(
                                v: Visualizer,
                                waveform: ByteArray,
                                samplingRate: Int
                            ) {
                                // not used
                            }
                        },
                        Visualizer.getMaxCaptureRate() / 2,
                        false,
                        true
                    )

                    enabled = true
                }
            }
        }

        player.addListener(listener)

        // in case session is already set
        val currentSession = player.audioSessionId
        if (currentSession != C.AUDIO_SESSION_ID_UNSET) {
            listener.onAudioSessionIdChanged(currentSession)
        }

        onDispose {
            player.removeListener(listener)
            visualizer?.release()
        }
    }

    return fftShader
}

// ---------------------- SHADER VIEW ----------------------

@Composable
fun SoundWaveShaderView(
    player: ExoPlayer,
    isPlaying: Boolean,
    modifier: Modifier = Modifier
) {
    val runtimeShader = remember { RuntimeShader(WAVE_SHADER_AGSL) }

    val fftShader = rememberFftShader(player)

    val infiniteTransition = rememberInfiniteTransition(label = "waveTime")
    val time by infiniteTransition.animateFloat(
        initialValue = 0f,
        targetValue = 1000f,
        animationSpec = infiniteRepeatable(
            animation = tween(durationMillis = 50_000, easing = LinearEasing)
        ),
        label = "time"
    )

    val intensity by animateFloatAsState(
        targetValue = if (isPlaying) 1f else 0f,
        animationSpec = tween(400),
        label = "intensity"
    )

    val waves = 16f

    Box(
        modifier = modifier.drawWithCache {
            runtimeShader.setFloatUniform("iResolution", size.width, size.height)
            runtimeShader.setFloatUniform("iTime", time)
            runtimeShader.setFloatUniform("WAVES", waves)

            // fallback to flat mag=0.3 if fftShader not ready
            val inputShader = fftShader ?: run {
                val w = 256
                val h = 1
                val bmp = Bitmap.createBitmap(w, h, Bitmap.Config.ARGB_8888)
                for (x in 0 until w) {
                    val color = android.graphics.Color.argb(
                        255,
                        (0.3f * 255).toInt(),
                        (0.3f * 128).toInt(),
                        255
                    )
                    bmp.setPixel(x, 0, color)
                }
                BitmapShader(bmp, Shader.TileMode.CLAMP, Shader.TileMode.CLAMP)
            }

            runtimeShader.setInputShader("iChannel0", inputShader)

            val brush = ShaderBrush(runtimeShader)

            onDrawBehind {
                if (intensity > 0f) {
                    drawRect(brush = brush)
                } else {
                    drawRect(color = Color.Black)
                }
            }
        }
    )
}

// ---------------------- PREVIEW (no real audio, just layout) ----------------------

@Preview(showBackground = true)
@Composable
fun PreviewFftMediaPlayer() {
    MaterialTheme {
        Surface {
            // Empty list, just to preview layout (no playback).
            FftMediaPlayer(audioUris = emptyList())
        }
    }
}